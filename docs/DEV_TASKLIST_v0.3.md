# Agent FamilyStage 开发清单 v0.3

更新时间：2026-02-12  
关联文档：`docs/PRDv0.3.md`

---

## 1. 开发范围与目标

本清单覆盖 `PRDv0.3` 的 MVP 范围（4 页面 + F-01~F-05），目标是让前后端可并行开发、按里程碑验收。

---

## 2. 任务分解（WBS）

## 2.1 基础准备

- `T-0001` 环境与配置校验（`.env.local`、OAuth、DB 连接）
- `T-0002` 路由与页面骨架确认（`/login`、`/`、`/stage/config`、`/stage/:id`）
- `T-0003` 日志字段规范统一（`requestId/sessionId/userId`）

## 2.2 F-01 登录与会话建立（P0）

- `T-0101` 新增独立登录页 UI 与交互（登录按钮、失败提示、重试）
- `T-0102` OAuth 跳转入口与回调收敛
- `T-0103` 登录态守卫（未登录重定向到 `/login`）
- `T-0104` `GET /api/me` 接口结果适配登录态展示

## 2.3 F-02 主页聚合展示（P0）

- `T-0201` 主页信息架构：我的信息卡 + Agent 列表 + 主行动按钮
- `T-0202` Agent 卡片组件（头像、昵称、状态标签）
- `T-0203` 主页数据聚合接口编排（`/api/me` + `/api/agents`）
- `T-0204` 空态/加载态/失败态统一处理

## 2.4 F-03 新年家庭剧场配置（P0）

- `T-0301` 场景选择组件（年夜饭/串门/拜年电话/家庭群聊）
- `T-0302` 主题选择 + 自定义主题输入组件
- `T-0303` 角色选择与 Agent 映射组件（一角色一 Agent）
- `T-0304` 前端校验（必填、重复角色、不可用 Agent）
- `T-0305` 会话创建接口 `POST /api/stage/session`
- `T-0306` 创建成功跳转对话页

## 2.5 F-04 多 Agent 流式对话（P0）

- `T-0401` 对话页布局（消息区、状态条、控制区）
- `T-0402` 会话启动接口 `POST /api/stage/session/{id}/start`
- `T-0403` SSE 消费 `GET /api/stage/session/{id}/stream`
- `T-0404` 增量渲染策略（按 `seq` 拼接 `delta`）
- `T-0405` 失败降级文案与重连机制
- `T-0406` 停止会话接口 `POST /api/stage/session/{id}/stop`

## 2.6 F-05 基础运营约束（P1）

- `T-0501` 会话创建时校验 Agent 状态（`REVOKED/INACTIVE` 拒绝）
- `T-0502` 历史消息脱敏入库策略（手机号/邮箱/证件号）
- `T-0503` 关键审计字段落库（`isFallback/isMasked`）

## 2.7 质量保障与发布

- `T-9001` 单元测试补充（校验逻辑、错误映射）
- `T-9002` 集成测试（会话创建、启动、流式、停止）
- `T-9003` E2E 场景（`S-01 ~ S-04`）
- `T-9004` 灰度发布开关与回滚脚本验证
- `T-9005` 监控看板与告警阈值配置

---

## 3. 里程碑计划（建议）

- `M1`（Day 1-2）：完成 F-01 + F-02 可演示版
- `M2`（Day 3-5）：完成 F-03 配置链路与会话创建
- `M3`（Day 6-8）：完成 F-04 流式对话与异常降级
- `M4`（Day 9-10）：完成 F-05 约束、测试、灰度发布

---

## 4. 验收映射（任务 → AC）

- `F-01`：`T-0101~T-0104` 对应 `AC-F01-01~03`
- `F-02`：`T-0201~T-0204` 对应 `AC-F02-01~03`
- `F-03`：`T-0301~T-0306` 对应 `AC-F03-01~03`
- `F-04`：`T-0401~T-0406` 对应 `AC-F04-01~03`
- `F-05`：`T-0501~T-0503` 对应 `AC-F05-01~03`
- E2E：`T-9003` 对应 `S-01~S-04`

---

## 5. 完成定义（DoD）

1. 功能：对应 AC 全通过，且与 `PRDv0.3` 不冲突。
2. 质量：关键路径具备自动化测试（至少单测 + 集成 + E2E 各一层）。
3. 可观测：关键接口日志含 `requestId/sessionId/userId`。
4. 发布：灰度开关可控，回滚路径可验证。

