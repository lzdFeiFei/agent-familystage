# Agent FamilyStage 需求与开发文档

更新时间：2026-02-11

## 1. 项目目标

在现有 SecondMe OAuth 网站基础上，扩展一个“春节亲戚模拟器”最小 MVP：

1. 允许他人通过 SecondMe 登录授权后进入公开 Agent 池。
2. 允许运营者将 Agent 手动绑定为“七大姑八大姨”角色。
3. 允许登录用户发起春节场景对话，由绑定 Agent 扮演角色回复。

## 2. 产品口径（当前冻结）

1. 可见范围：所有登录用户可用。
2. 角色映射：手动绑定。
3. 内容风格：轻度魔幻。
4. 身份展示：仅显示角色名，不展示授权人真实昵称。
5. 撤销策略：立即下线角色，历史会话保留脱敏记录。
6. 同意机制：登录即默认加入公开池。
7. MVP 页面范围：3 页（角色池、绑定页、聊天页）。

## 3. 已实现功能清单

## 3.1 登录与授权

1. OAuth 登录/回调/登出已可用：
- `src/app/api/auth/login/route.ts`
- `src/app/api/auth/callback/route.ts`
- `src/app/api/auth/logout/route.ts`
2. 回调成功后自动 `upsert` `AgentProfile`，默认进入公开池（`ACTIVE + PUBLIC`）。

## 3.2 Agent 池与角色绑定

1. 公开 Agent 池接口：`GET /api/agents/public`
2. 角色绑定接口：`POST /api/roles/bind`
3. 绑定列表接口：`GET /api/roles/bindings`
4. 撤销 Agent 接口：`POST /api/agents/revoke`

## 3.3 聊天闭环

1. 创建会话：`POST /api/chat/sessions`
2. 发送消息：`POST /api/chat/messages`
3. 拉取消息：`GET /api/chat/sessions/[id]/messages`
4. 支持按角色权重随机选取可用 Agent。
5. 上游失败时提供降级回复（防止对话直接中断）。
6. 新增自动群聊接口：`POST /api/chat/auto`（多角色自动轮流发言，无需人工输入）。

## 3.4 前端页面

1. 首页：`/`（新增角色池/绑定/聊天入口）
2. 角色池页：`/agents`
3. 绑定页：`/roles`
4. 聊天页：`/chat`
5. 聊天页已调整为“自动多 Agent 对话模式”，输入框已移除。

## 3.5 安全与脱敏

1. 敏感词拦截（输入校验）：
- `src/lib/safety.ts` -> `checkSafety`
2. 关键信息脱敏（手机号/邮箱/证件号模式）：
- `src/lib/safety.ts` -> `maskSensitiveContent`
3. 撤销后禁止新会话使用对应 Agent。

## 4. 数据模型（Prisma）

文件：`prisma/schema.prisma`

新增模型：

1. `AgentProfile`
- 归属用户、同意状态、可见性、撤销时间
2. `RoleBinding`
- 角色键、Agent 关联、启用状态、权重、创建人
3. `ChatSession`
- 发起用户、角色、场景、绑定 Agent、会话状态
4. `ChatMessage`
- 会话消息、发送方、内容、是否脱敏

新增枚举：

1. `ConsentStatus`：`ACTIVE | REVOKED`
2. `AgentVisibility`：`PUBLIC`
3. `SessionStatus`：`ACTIVE | CLOSED`
4. `MessageSender`：`USER | AGENT`

## 5. 关键技术实现

## 5.1 服务层

1. 当前用户解析与管理员判定：
- `src/lib/current-user.ts`
2. 角色与场景配置：
- `src/lib/roles.ts`
3. 角色挑选与回复生成：
- `src/lib/roleplay.ts`
4. SecondMe API 封装（含 token endpoint 容错）：
- `src/lib/secondme.ts`

## 5.2 配置项

`.env.local` 新增/使用：

1. `SECONDME_CHAT_ENDPOINT`（默认 `/api/secondme/chat/stream`）
2. `ADMIN_USER_IDS`（空=所有登录用户可管理绑定）
3. `SECONDME_TOKEN_ENDPOINT` 使用官方值：
- `https://app.mindos.com/gate/lab/api/oauth/token/code`

## 6. 已完成验证

执行通过：

1. `npx prisma generate`
2. `npx prisma db push`
3. `npm run lint`
4. `npm run build`

当前可访问路由（节选）：

1. 页面：`/` `/agents` `/roles` `/chat`
2. API：`/api/agents/public` `/api/roles/bind` `/api/roles/bindings` `/api/agents/revoke` `/api/chat/sessions` `/api/chat/messages` `/api/chat/auto`

## 7. 已知限制与待办

1. 若上游返回格式发生变化（SSE 字段结构变化），需同步调整 `src/lib/secondme.ts` 的解析逻辑。
2. 当前“管理员”机制使用 `ADMIN_USER_IDS`，后续建议升级为正式 RBAC。
3. 当前同意策略为“登录即加入公开池”，若上线需评估合规，建议后续改为二次确认。
4. 当前只做文本对话，未接入语音/多模态。
5. 生产环境建议迁移 SQLite 到 PostgreSQL/MySQL。

## 8. 下一步建议

1. 接入真实可用的 SecondMe chat 上游端点并做字段适配。
2. 增加 E2E 自动化测试（登录、绑定、聊天、撤销四条主链路）。
3. 新增运营看板（会话量、成功率、撤销率、拦截率）。
4. 增加用户侧“加入公开池”显式开关与授权说明文案。

## 9. 接口排查记录（2026-02-11）

问题现象：

1. `sendRoleplayChat` 调用返回 `404`，日志为 `SecondMe chat failed: 404`。

排查结论（官方文档）：

1. Chat API 官方端点为 `POST /api/secondme/chat/stream`（SSE 返回），不是 `/api/secondme/chat`。
2. Chat 文档明确返回 `text/event-stream`，消息体通过 `data: {...}` 增量片段返回。

本次修复：

1. `src/lib/secondme.ts`
- 默认端点修正为 `/api/secondme/chat/stream`
- 增加 SSE 解析逻辑（拼接 `choices[].delta.content`）
- 增加端点兜底（若配置为 `/chat`，自动尝试 `/chat/stream`）
2. `.env.local` 与 `README.md` 默认配置同步为 `/api/secondme/chat/stream`

参考文档：

1. Quickstart: `https://develop-docs.second.me/zh/docs`
2. API Reference / SecondMe: `https://develop-docs.second.me/zh/docs/api-reference/secondme`
3. Chat Stream: `https://develop-docs.second.me/zh/docs/api-reference/secondme/chat`

## 10. 接口开发流程约定（新增）

从本次开始，凡涉及 SecondMe 接口变更或新增，必须遵循以下流程：

1. 先查官方文档（以 `develop-docs.second.me` 为准），确认：
- 端点路径
- 请求方法
- 请求参数
- 响应格式（JSON / SSE）
2. 再实现代码，不允许先猜接口。
3. 接口落地后，在本文件追加“接口排查记录”（包含问题、结论、链接、改动）。
